# Stratum CDP - Repository Discovery

> Generated: 2026-01-13
> Purpose: Document existing patterns to ensure CDP implementation aligns with codebase conventions

---

## 1. Backend Architecture

### Framework & Language
| Component | Technology | Version |
|-----------|------------|---------|
| Framework | FastAPI | 0.109.2 |
| Python | Python | 3.11+ |
| ASGI Server | Uvicorn | 0.27.1 |
| Task Queue | Celery | 5.3.6 |

### Folder Structure
```
backend/
├── app/
│   ├── main.py                    # FastAPI app factory
│   ├── base_models.py             # Core SQLAlchemy models
│   ├── base_schemas.py            # Core Pydantic schemas
│   ├── api/v1/
│   │   ├── __init__.py            # Router aggregation
│   │   └── endpoints/             # 40+ endpoint modules
│   ├── auth/
│   │   ├── deps.py                # get_current_user dependency
│   │   └── permissions.py         # RBAC logic
│   ├── core/
│   │   ├── config.py              # Settings (Pydantic)
│   │   ├── security.py            # JWT, hashing, encryption
│   │   └── logging.py             # structlog setup
│   ├── db/
│   │   ├── base.py                # Base class + mixins
│   │   └── session.py             # Async/sync sessions
│   ├── models/                    # Domain models (autopilot, trust, etc.)
│   ├── schemas/                   # Domain Pydantic schemas
│   ├── services/                  # External API integrations
│   ├── middleware/
│   │   ├── tenant.py              # Tenant context extraction
│   │   └── audit.py               # Audit logging
│   └── workers/                   # Celery tasks
├── migrations/                    # Alembic migrations
└── tests/
    ├── conftest.py                # Unit test fixtures
    ├── unit/                      # Unit tests
    └── integration/               # Integration tests
```

---

## 2. Database

### Type & ORM
| Component | Technology | Version |
|-----------|------------|---------|
| Database | PostgreSQL | 15 |
| ORM | SQLAlchemy | 2.0.27 |
| Async Driver | asyncpg | 0.29.0 |
| Sync Driver | psycopg2-binary | 2.9.9 |
| Migrations | Alembic | 1.13.1 |

### Naming Conventions
- **Tables**: `snake_case` plural (e.g., `tenants`, `campaigns`, `audit_logs`)
- **Columns**: `snake_case` (e.g., `tenant_id`, `created_at`, `is_active`)
- **Foreign Keys**: `{table_singular}_id` (e.g., `tenant_id`, `user_id`)
- **Indexes**: Auto-generated by SQLAlchemy naming convention
- **Enums**: PascalCase in Python, lowercase in DB

### Base Classes & Mixins
```python
# From backend/app/db/base.py

class Base(DeclarativeBase):
    """All models inherit from this"""
    metadata = MetaData(naming_convention=convention)

class TimestampMixin:
    """Adds created_at, updated_at (auto-managed)"""
    created_at: Mapped[datetime]
    updated_at: Mapped[datetime]

class SoftDeleteMixin:
    """Adds deleted_at, is_deleted (no hard deletes)"""
    deleted_at: Mapped[Optional[datetime]]
    is_deleted: Mapped[bool] = False

class TenantMixin:
    """Adds tenant_id FK with cascade delete"""
    tenant_id: Mapped[int]  # FK to tenants.id
```

### Session Management
```python
# Async for FastAPI routes
async_engine = create_async_engine(settings.database_url, pool_size=10)
async_session_maker = async_sessionmaker(async_engine)

# Dependency injection
async def get_async_session() -> AsyncGenerator[AsyncSession, None]:
    async with async_session_maker() as session:
        yield session
```

---

## 3. API Patterns

### Routing Structure
- **Base path**: `/api/v1/`
- **Router files**: `backend/app/api/v1/endpoints/{feature}.py`
- **Router registration**: `backend/app/api/v1/__init__.py`

### Router Example Pattern
```python
# backend/app/api/v1/endpoints/example.py
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession

from app.auth.deps import get_current_user
from app.db.session import get_async_session
from app.schemas.example import ExampleCreate, ExampleResponse

router = APIRouter(prefix="/examples", tags=["Examples"])

@router.post("/", response_model=ExampleResponse, status_code=status.HTTP_201_CREATED)
async def create_example(
    data: ExampleCreate,
    db: AsyncSession = Depends(get_async_session),
    current_user: User = Depends(get_current_user),
):
    """Create a new example."""
    # Implementation
    pass
```

### Authentication
- **Method**: JWT Bearer tokens (HS256)
- **Dependency**: `get_current_user` from `app/auth/deps.py`
- **Headers**: `Authorization: Bearer <token>`
- **Tenant Header**: `X-Tenant-ID` (extracted by middleware)

### Validation
- **Library**: Pydantic v2.6.1
- **Base Schema**:
```python
class BaseSchema(BaseModel):
    model_config = ConfigDict(
        from_attributes=True,
        str_strip_whitespace=True,
        validate_assignment=True,
    )
```

### Response Pattern
```python
class APIResponse(BaseModel, Generic[DataT]):
    success: bool = True
    data: Optional[DataT] = None
    message: Optional[str] = None
    errors: Optional[List[dict]] = None
```

---

## 4. Multi-Tenancy

### Implementation Pattern
- **Row-Level Security**: All tenant-scoped tables have `tenant_id` column
- **Middleware**: `TenantMiddleware` extracts tenant from JWT or header
- **Request State**: `request.state.tenant_id` available in all routes
- **Query Filter**: All queries filter by `tenant_id`

### TenantMixin Usage
```python
class Campaign(Base, TenantMixin, TimestampMixin, SoftDeleteMixin):
    __tablename__ = "campaigns"

    id: Mapped[int] = mapped_column(primary_key=True)
    # tenant_id inherited from TenantMixin
    name: Mapped[str] = mapped_column(String(255))
```

---

## 5. Frontend Architecture

### Framework & Libraries
| Component | Technology | Version |
|-----------|------------|---------|
| Framework | React | 18.2.0 |
| Language | TypeScript | 5.3.3 |
| Build Tool | Vite | 5.1.0 |
| Styling | Tailwind CSS | 3.4.1 |
| State | Zustand | 4.5.1 |
| Data Fetching | TanStack Query | 5.20.5 |
| HTTP Client | Axios | 1.6.7 |
| Forms | React Hook Form | 7.69.0 |
| Validation | Zod | 3.25.76 |
| UI Primitives | Radix UI | Various |
| Charts | Recharts / Tremor | 2.12.1 / 3.14.1 |

### Folder Structure
```
frontend/src/
├── components/
│   ├── ui/                 # Base UI components (Radix-based)
│   ├── widgets/            # Dashboard widgets (KPIWidget, SimulatorWidget)
│   ├── common/             # Shared utilities (LoadingSpinner)
│   └── {feature}/          # Feature-specific components
├── views/
│   ├── tenant/             # Tenant-scoped pages
│   ├── superadmin/         # Admin pages
│   └── *.tsx               # Top-level pages
├── api/
│   ├── client.ts           # Axios instance
│   └── {feature}.ts        # Feature API hooks
├── stores/                 # Zustand stores
├── contexts/               # React Context (Auth, Theme)
├── hooks/                  # Custom hooks
├── lib/
│   └── utils.ts            # Utilities (cn, formatCurrency)
├── types/                  # Global TypeScript types
└── i18n/                   # Internationalization
```

### Component Pattern
```typescript
interface ComponentProps {
  className?: string;
  // other props
}

export function ComponentName({ className }: ComponentProps) {
  const [state, setState] = useState(initialValue);

  return (
    <div className={cn('base-classes', className)}>
      {/* JSX */}
    </div>
  );
}
```

### API Hook Pattern
```typescript
// Using TanStack Query
export function useExamples(tenantId: number) {
  return useQuery({
    queryKey: ['examples', tenantId],
    queryFn: () => apiClient.get(`/tenants/${tenantId}/examples`),
    staleTime: 5 * 60 * 1000,
  });
}

export function useCreateExample() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: (data: ExampleCreate) => apiClient.post('/examples', data),
    onSuccess: () => queryClient.invalidateQueries(['examples']),
  });
}
```

---

## 6. Testing Patterns

### Backend (pytest)
| Aspect | Configuration |
|--------|--------------|
| Framework | pytest + pytest-asyncio |
| Async Mode | `asyncio_mode = auto` |
| Markers | `@pytest.mark.unit`, `@pytest.mark.integration` |
| Coverage | 70% minimum |
| Fixtures | `tests/conftest.py`, `tests/integration/conftest.py` |

**File Naming**: `test_{feature}.py`

**Test Structure**:
```python
@pytest.fixture
def sample_data():
    return {"key": "value"}

class TestFeature:
    @pytest.mark.asyncio
    async def test_something(self, sample_data, db_session):
        """Test description."""
        result = await do_something(sample_data)
        assert result.success is True
```

### Frontend (Vitest)
| Aspect | Configuration |
|--------|--------------|
| Framework | Vitest + @testing-library/react |
| Environment | jsdom |
| Coverage | 60% minimum |
| E2E | Playwright |

**File Naming**: `{Component}.test.tsx` or `{util}.test.ts`

**Test Structure**:
```typescript
import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';

describe('ComponentName', () => {
  it('should render correctly', () => {
    render(<ComponentName />);
    expect(screen.getByRole('button')).toBeInTheDocument();
  });
});
```

---

## 7. Existing Patterns to Follow

### Error Handling
```python
# Backend: HTTPException with status codes
raise HTTPException(
    status_code=status.HTTP_404_NOT_FOUND,
    detail="Resource not found"
)

# Frontend: Try-catch with toast notifications
try {
  await mutation.mutateAsync(data);
  toast({ title: 'Success', description: 'Created successfully' });
} catch (error) {
  toast({ title: 'Error', description: error.message, variant: 'destructive' });
}
```

### Logging
```python
# Backend: structlog with tenant context
import structlog
logger = structlog.get_logger()

logger.info("event_processed", tenant_id=tenant_id, event_id=event_id)
```

### Feature Flags
```python
# Stored in tenant.feature_flags JSONB column
# Accessed via TenantStore in frontend
```

---

## 8. CDP Implementation Implications

Based on discovery, CDP should:

1. **Models**: Create in `backend/app/models/cdp.py`, inherit from `Base`, `TenantMixin`, `TimestampMixin`
2. **Schemas**: Create in `backend/app/schemas/cdp.py`, inherit from `BaseSchema`
3. **Router**: Create `backend/app/api/v1/endpoints/cdp.py` with standard patterns
4. **Migrations**: Use Alembic, place in `backend/migrations/versions/`
5. **Tests**:
   - Unit: `backend/tests/unit/test_cdp.py`
   - Integration: `backend/tests/integration/test_cdp.py`
6. **Frontend**:
   - API: `frontend/src/api/cdp.ts`
   - Component: `frontend/src/components/widgets/ROICalculator.tsx`
7. **Multi-tenancy**: All tables need `tenant_id` column with FK

---

## 9. Key Files Reference

| Purpose | Backend Path | Frontend Path |
|---------|-------------|---------------|
| Entry Point | `app/main.py` | `src/main.tsx` |
| DB Session | `app/db/session.py` | - |
| Base Models | `app/db/base.py` | - |
| Auth Deps | `app/auth/deps.py` | - |
| Config | `app/core/config.py` | - |
| API Client | - | `src/api/client.ts` |
| Utilities | `app/core/security.py` | `src/lib/utils.ts` |
| Router Registry | `app/api/v1/__init__.py` | `src/App.tsx` |

---

## 10. Commands Reference

```bash
# Backend
make dev              # Start local dev server
make test             # Run pytest
make migrate          # Run Alembic migrations
alembic revision --autogenerate -m "message"  # Create migration

# Frontend
npm run dev           # Start Vite dev server
npm run test          # Run Vitest
npm run build         # Production build

# Docker
docker compose up -d  # Start full stack
```
