{"version":3,"file":"emqV2-BxKuXu1r.js","sources":["../../src/api/emqV2.ts"],"sourcesContent":["/**\r\n * Stratum AI - EMQ v2 Enhanced API\r\n *\r\n * Event Measurement Quality endpoints with Trust Layer integration\r\n */\r\n\r\nimport { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';\r\nimport { apiClient, ApiResponse } from './client';\r\n\r\n// Types\r\nexport interface EmqDriver {\r\n  name: string;\r\n  value: number;\r\n  weight: number;\r\n  status: 'good' | 'warning' | 'critical';\r\n  trend: 'up' | 'down' | 'flat';\r\n}\r\n\r\nexport interface EmqScore {\r\n  score: number;\r\n  previousScore: number;\r\n  confidenceBand: 'reliable' | 'directional' | 'unsafe';\r\n  drivers: EmqDriver[];\r\n  lastUpdated: string;\r\n}\r\n\r\nexport interface ConfidenceData {\r\n  band: 'reliable' | 'directional' | 'unsafe';\r\n  score: number;\r\n  thresholds: {\r\n    reliable: number;\r\n    directional: number;\r\n  };\r\n  factors: {\r\n    name: string;\r\n    contribution: number;\r\n    status: 'positive' | 'negative' | 'neutral';\r\n  }[];\r\n}\r\n\r\nexport interface PlaybookItem {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  priority: 'critical' | 'high' | 'medium' | 'low';\r\n  owner: string | null;\r\n  estimatedImpact: number;\r\n  estimatedTime: string | null;\r\n  platform: string | null;\r\n  status: 'pending' | 'in_progress' | 'completed';\r\n  actionUrl: string | null;\r\n}\r\n\r\nexport interface EmqIncident {\r\n  id: string;\r\n  type: 'incident_opened' | 'incident_closed' | 'degradation' | 'recovery';\r\n  title: string;\r\n  description: string | null;\r\n  timestamp: string;\r\n  platform: string | null;\r\n  severity: 'critical' | 'high' | 'medium' | 'low';\r\n  recoveryHours: number | null;\r\n  emqImpact: number | null;\r\n}\r\n\r\nexport interface EmqImpact {\r\n  totalImpact: number;\r\n  currency: string;\r\n  breakdown: {\r\n    platform: string;\r\n    actualRoas: number;\r\n    estimatedRoas: number;\r\n    confidence: number;\r\n    revenueImpact: number;\r\n  }[];\r\n}\r\n\r\nexport interface EmqVolatility {\r\n  svi: number; // Signal Volatility Index\r\n  trend: 'increasing' | 'decreasing' | 'stable';\r\n  weeklyData: {\r\n    date: string;\r\n    value: number;\r\n  }[];\r\n}\r\n\r\nexport interface EmqBenchmark {\r\n  platform: string;\r\n  p25: number;\r\n  p50: number;\r\n  p75: number;\r\n  tenantScore: number;\r\n  percentile: number;\r\n}\r\n\r\nexport interface EmqPortfolio {\r\n  totalTenants: number;\r\n  byBand: {\r\n    reliable: number;\r\n    directional: number;\r\n    unsafe: number;\r\n  };\r\n  atRiskBudget: number;\r\n  avgScore: number;\r\n  topIssues: {\r\n    driver: string;\r\n    affectedTenants: number;\r\n  }[];\r\n}\r\n\r\nexport type AutopilotMode = 'normal' | 'limited' | 'cuts_only' | 'frozen';\r\n\r\nexport interface AutopilotState {\r\n  mode: AutopilotMode;\r\n  reason: string | null;\r\n  budgetAtRisk: number;\r\n  allowedActions: string[];\r\n  restrictedActions: string[];\r\n}\r\n\r\n// API Functions\r\nexport const emqV2Api = {\r\n  /**\r\n   * Get current EMQ score for a tenant\r\n   */\r\n  getEmqScore: async (tenantId: number, date?: string): Promise<EmqScore> => {\r\n    const params = date ? { date } : {};\r\n    const response = await apiClient.get<ApiResponse<EmqScore>>(\r\n      `/emq/v2/tenants/${tenantId}/score`,\r\n      { params }\r\n    );\r\n    return response.data.data;\r\n  },\r\n\r\n  /**\r\n   * Get confidence band details\r\n   */\r\n  getConfidence: async (tenantId: number, date?: string): Promise<ConfidenceData> => {\r\n    const params = date ? { date } : {};\r\n    const response = await apiClient.get<ApiResponse<ConfidenceData>>(\r\n      `/emq/v2/tenants/${tenantId}/confidence`,\r\n      { params }\r\n    );\r\n    return response.data.data;\r\n  },\r\n\r\n  /**\r\n   * Get fix playbook items\r\n   */\r\n  getPlaybook: async (tenantId: number): Promise<PlaybookItem[]> => {\r\n    const response = await apiClient.get<ApiResponse<PlaybookItem[]>>(\r\n      `/emq/v2/tenants/${tenantId}/playbook`\r\n    );\r\n    return response.data.data;\r\n  },\r\n\r\n  /**\r\n   * Update playbook item status\r\n   */\r\n  updatePlaybookItem: async (\r\n    tenantId: number,\r\n    itemId: string,\r\n    updates: Partial<Pick<PlaybookItem, 'status' | 'owner'>>\r\n  ): Promise<PlaybookItem> => {\r\n    const response = await apiClient.patch<ApiResponse<PlaybookItem>>(\r\n      `/emq/v2/tenants/${tenantId}/playbook/${itemId}`,\r\n      updates\r\n    );\r\n    return response.data.data;\r\n  },\r\n\r\n  /**\r\n   * Get incident timeline\r\n   */\r\n  getIncidents: async (\r\n    tenantId: number,\r\n    startDate: string,\r\n    endDate: string\r\n  ): Promise<EmqIncident[]> => {\r\n    const response = await apiClient.get<ApiResponse<EmqIncident[]>>(\r\n      `/emq/v2/tenants/${tenantId}/incidents`,\r\n      { params: { start_date: startDate, end_date: endDate } }\r\n    );\r\n    return response.data.data;\r\n  },\r\n\r\n  /**\r\n   * Get ROAS impact estimate\r\n   */\r\n  getImpact: async (tenantId: number, startDate: string, endDate: string): Promise<EmqImpact> => {\r\n    const response = await apiClient.get<ApiResponse<EmqImpact>>(\r\n      `/emq/v2/tenants/${tenantId}/impact`,\r\n      { params: { start_date: startDate, end_date: endDate } }\r\n    );\r\n    return response.data.data;\r\n  },\r\n\r\n  /**\r\n   * Get signal volatility data\r\n   */\r\n  getVolatility: async (tenantId: number, week?: string): Promise<EmqVolatility> => {\r\n    const params = week ? { week } : {};\r\n    const response = await apiClient.get<ApiResponse<EmqVolatility>>(\r\n      `/emq/v2/tenants/${tenantId}/volatility`,\r\n      { params }\r\n    );\r\n    return response.data.data;\r\n  },\r\n\r\n  /**\r\n   * Get autopilot state\r\n   */\r\n  getAutopilotState: async (tenantId: number): Promise<AutopilotState> => {\r\n    const response = await apiClient.get<ApiResponse<AutopilotState>>(\r\n      `/emq/v2/tenants/${tenantId}/autopilot`\r\n    );\r\n    return response.data.data;\r\n  },\r\n\r\n  /**\r\n   * Update autopilot mode (manual override)\r\n   */\r\n  updateAutopilotMode: async (\r\n    tenantId: number,\r\n    mode: AutopilotMode,\r\n    reason?: string\r\n  ): Promise<AutopilotState> => {\r\n    const response = await apiClient.put<ApiResponse<AutopilotState>>(\r\n      `/emq/v2/tenants/${tenantId}/autopilot`,\r\n      { mode, reason }\r\n    );\r\n    return response.data.data;\r\n  },\r\n\r\n  // Super Admin endpoints\r\n  /**\r\n   * Get EMQ benchmarks across platform (super admin)\r\n   */\r\n  getBenchmarks: async (date?: string, platform?: string): Promise<EmqBenchmark[]> => {\r\n    const params: Record<string, string> = {};\r\n    if (date) params.date = date;\r\n    if (platform) params.platform = platform;\r\n    const response = await apiClient.get<ApiResponse<EmqBenchmark[]>>('/emq/v2/benchmarks', {\r\n      params,\r\n    });\r\n    return response.data.data;\r\n  },\r\n\r\n  /**\r\n   * Get portfolio overview (super admin)\r\n   */\r\n  getPortfolio: async (date?: string): Promise<EmqPortfolio> => {\r\n    const params = date ? { date } : {};\r\n    const response = await apiClient.get<ApiResponse<EmqPortfolio>>('/emq/v2/portfolio', {\r\n      params,\r\n    });\r\n    return response.data.data;\r\n  },\r\n};\r\n\r\n// React Query Hooks\r\n\r\nexport function useEmqScore(tenantId: number, date?: string) {\r\n  return useQuery({\r\n    queryKey: ['emq', 'score', tenantId, date],\r\n    queryFn: () => emqV2Api.getEmqScore(tenantId, date),\r\n    staleTime: 60 * 1000, // 1 minute\r\n    refetchInterval: 5 * 60 * 1000, // Refetch every 5 minutes\r\n  });\r\n}\r\n\r\nexport function useConfidence(tenantId: number, date?: string) {\r\n  return useQuery({\r\n    queryKey: ['emq', 'confidence', tenantId, date],\r\n    queryFn: () => emqV2Api.getConfidence(tenantId, date),\r\n    staleTime: 60 * 1000,\r\n  });\r\n}\r\n\r\nexport function useEmqPlaybook(tenantId: number) {\r\n  return useQuery({\r\n    queryKey: ['emq', 'playbook', tenantId],\r\n    queryFn: () => emqV2Api.getPlaybook(tenantId),\r\n    staleTime: 30 * 1000,\r\n  });\r\n}\r\n\r\nexport function useUpdatePlaybookItem(tenantId: number) {\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: ({\r\n      itemId,\r\n      updates,\r\n    }: {\r\n      itemId: string;\r\n      updates: Partial<Pick<PlaybookItem, 'status' | 'owner'>>;\r\n    }) => emqV2Api.updatePlaybookItem(tenantId, itemId, updates),\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['emq', 'playbook', tenantId] });\r\n    },\r\n  });\r\n}\r\n\r\nexport function useEmqIncidents(tenantId: number, startDate: string, endDate: string) {\r\n  return useQuery({\r\n    queryKey: ['emq', 'incidents', tenantId, startDate, endDate],\r\n    queryFn: () => emqV2Api.getIncidents(tenantId, startDate, endDate),\r\n    staleTime: 60 * 1000,\r\n  });\r\n}\r\n\r\nexport function useEmqImpact(tenantId: number, startDate: string, endDate: string) {\r\n  return useQuery({\r\n    queryKey: ['emq', 'impact', tenantId, startDate, endDate],\r\n    queryFn: () => emqV2Api.getImpact(tenantId, startDate, endDate),\r\n    staleTime: 5 * 60 * 1000,\r\n  });\r\n}\r\n\r\nexport function useEmqVolatility(tenantId: number, week?: string) {\r\n  return useQuery({\r\n    queryKey: ['emq', 'volatility', tenantId, week],\r\n    queryFn: () => emqV2Api.getVolatility(tenantId, week),\r\n    staleTime: 60 * 1000,\r\n  });\r\n}\r\n\r\nexport function useAutopilotState(tenantId: number) {\r\n  return useQuery({\r\n    queryKey: ['emq', 'autopilot', tenantId],\r\n    queryFn: () => emqV2Api.getAutopilotState(tenantId),\r\n    staleTime: 30 * 1000,\r\n    refetchInterval: 60 * 1000,\r\n  });\r\n}\r\n\r\nexport function useUpdateAutopilotMode(tenantId: number) {\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: ({ mode, reason }: { mode: AutopilotMode; reason?: string }) =>\r\n      emqV2Api.updateAutopilotMode(tenantId, mode, reason),\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['emq', 'autopilot', tenantId] });\r\n    },\r\n  });\r\n}\r\n\r\n// Super Admin hooks\r\nexport function useEmqBenchmarks(date?: string, platform?: string) {\r\n  return useQuery({\r\n    queryKey: ['emq', 'benchmarks', date, platform],\r\n    queryFn: () => emqV2Api.getBenchmarks(date, platform),\r\n    staleTime: 5 * 60 * 1000,\r\n  });\r\n}\r\n\r\nexport function useEmqPortfolio(date?: string) {\r\n  return useQuery({\r\n    queryKey: ['emq', 'portfolio', date],\r\n    queryFn: () => emqV2Api.getPortfolio(date),\r\n    staleTime: 5 * 60 * 1000,\r\n  });\r\n}\r\n"],"names":["emqV2Api","tenantId","date","params","apiClient","itemId","updates","startDate","endDate","week","mode","reason","platform","useEmqScore","useQuery","useEmqPlaybook","useUpdatePlaybookItem","queryClient","useQueryClient","useMutation","useEmqIncidents","useEmqVolatility","useAutopilotState","useUpdateAutopilotMode","useEmqBenchmarks","useEmqPortfolio"],"mappings":"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"}